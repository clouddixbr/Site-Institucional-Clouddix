trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  phpVersion: '8.2'
  azureSubscription: 'AzureServiceConnection-site'
  appName: 'siteclouddix'

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: Build
    displayName: 'Build Job'
    steps:
    - script: |
        sudo update-alternatives --set php /usr/bin/php$(phpVersion)
        php -v
      displayName: 'Setup PHP $(phpVersion)'
      continueOnError: true

    - script: |
        sudo apt-get update
        sudo apt-get install -y php$(phpVersion) php$(phpVersion)-cli php$(phpVersion)-common php$(phpVersion)-mbstring php$(phpVersion)-xml php$(phpVersion)-zip php$(phpVersion)-curl
        php -v
      displayName: 'Install PHP $(phpVersion) if needed'
      condition: failed()

    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
        replaceExistingArchive: true
      displayName: 'Archive Files'

    - publish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
      artifact: drop
      displayName: 'Publish Artifact'

- stage: Deploy_Staging
  displayName: 'Deploy to Staging'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: 'Deploy to Staging Slot'
    environment: 'staging'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            inputs:
              azureSubscription: $(azureSubscription)
              appType: 'webAppLinux'
              appName: $(appName)
              package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
              deployToSlotOrASE: true
              resourceGroupName: 'rg-hml-site-clouddix-brs'
              slotName: 'staging'
              runtimeStack: 'PHP|8.2'
            displayName: 'Deploy to App Service Staging'

- stage: Approval
  displayName: 'Approval Stage'
  dependsOn: Deploy_Staging
  jobs:
  - job: waitForValidation
    displayName: 'Wait for Manager Approval'
    pool: server
    timeoutInMinutes: 4320 # 3 days
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: 'suporteclouddix@gmail.com'
        instructions: 'Please validate the staging deployment before promoting to production'
        onTimeout: 'reject'

- stage: Deploy_Production
  displayName: 'Deploy to Production'
  dependsOn: Approval
  condition: succeeded()
  jobs:
  - deployment: Deploy
    displayName: 'Deploy to Production'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureWebApp@1
            inputs:
              azureSubscription: $(azureSubscription)
              appType: 'webAppLinux'
              appName: $(appName)
              package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
              runtimeStack: 'PHP|8.2'
            displayName: 'Deploy to App Service Production'